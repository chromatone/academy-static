import{w as D,j as I,a as R,u as A}from"./chunk-LDFD35JM.MuarxFtH.js";import{E as m,G as W}from"./framework.-YauBPkH.js";function L(e){return JSON.stringify({...e,type:"auth"})}var q=()=>JSON.stringify({type:"pong"}),T=(e,i=1e3)=>new Promise((r,h)=>{let o=b=>{try{let w=JSON.parse(b.data);typeof w=="object"&&!Array.isArray(w)&&w!==null?(d(),r(w)):(d(),u())}catch{d(),r(b)}},u=()=>h(),d=()=>{clearTimeout(v),e.removeEventListener("message",o),e.removeEventListener("error",u),e.removeEventListener("close",u)};e.addEventListener("message",o),e.addEventListener("error",u),e.addEventListener("close",u);let v=setTimeout(()=>{d(),r(void 0)},i)});function*P(){let e=1;for(;;)yield String(e),e++}var B={authMode:"handshake",heartbeat:!0,reconnect:{delay:1e3,retries:10}},p={OPEN:1,CLOSED:3};function G(e={}){return i=>{e={...B,...e};let r=null,h=P(),o=0,u=!1,d=t=>"getToken"in t,v=async(t,a)=>{if(e.authMode==="strict"&&d(a)){let n=await a.getToken();n&&t.searchParams.set("access_token",n)}return t},b=async t=>{if("url"in e)return await v(new i.globals.URL(e.url),t);if(["ws:","wss:"].includes(i.url.protocol))return await v(i.url,t);let a=new i.globals.URL(i.url.toString());return a.protocol=i.url.protocol==="https:"?"wss:":"ws:",a.pathname="/websocket",await v(a,t)},w=()=>{r=null,h=P()};function x(){e.reconnect&&!u&&o<e.reconnect.retries?(u=!0,setTimeout(()=>{o+=1,this.connect().then(()=>{o=0,u=!1}).catch(()=>{})},Math.max(1,e.reconnect.delay))):u=!1}let f={open:new Set([]),error:new Set([]),close:new Set([]),message:new Set([])},C=async(t,a)=>{for(;t.readyState!==p.CLOSED;){let n=await T(t).catch(()=>{});if(n){if("type"in n){if(n.type==="auth"&&"status"in n&&n.status==="error"&&"error"in n){if(n.error==="TOKEN_EXPIRED"&&d(a)){let c=await a.getToken();if(c){t.send(L({access_token:c}));continue}}if(n.error==="AUTH_TIMEOUT"){t.close();continue}}if(e.heartbeat&&n.type==="ping"){t.send(q());continue}}f.message.forEach(c=>c.call(t,n))}}};return{async connect(){let t=this,a=await b(t);return new Promise((n,c)=>{let g=!1,l=new i.globals.WebSocket(a);l.addEventListener("open",async s=>{if(e.authMode==="handshake"&&d(t)){let y=await t.getToken();y&&l.send(L({access_token:y}))}g=!0,f.open.forEach(y=>y.call(l,s)),C(l,t),n()}),l.addEventListener("error",s=>{f.error.forEach(y=>y.call(l,s)),l.close(),g||c(s)}),l.addEventListener("close",s=>{f.close.forEach(y=>y.call(l,s)),w(),x.call(this),g||c(s)}),r=l})},disconnect(){r&&(r==null?void 0:r.readyState)===p.OPEN&&r.close(),r=null},onWebSocket(t,a){if(t==="message"){let n=function(c){if(typeof c.data!="string")return a.call(this,c);try{return a.call(this,JSON.parse(c.data))}catch{return a.call(this,c)}};return f[t].add(n),()=>f[t].delete(n)}return f[t].add(a),()=>f[t].delete(a)},sendMessage(t){if(!r||(r==null?void 0:r.readyState)!==p.OPEN)throw new Error("websocket connection not OPEN");if(typeof t=="string"){r.send(t);return}"uid"in t||(t.uid=h.next().value),r==null||r.send(JSON.stringify(t))},async subscribe(t,a={}){(!r||r.readyState!==p.OPEN)&&await this.connect(),"uid"in a||(a.uid=h.next().value);let n=!0,c=r,g=s=>c.send(JSON.stringify(s));g({...a,collection:t,type:"subscribe"});async function*l(){for(;n&&c&&c.readyState===p.OPEN;){let s=await T(c).catch(()=>{});if(s){if("type"in s&&"status"in s&&s.type==="subscribe"&&s.status==="error")throw s;"type"in s&&"uid"in s&&s.type==="subscription"&&s.uid===a.uid&&(yield s)}}if(e.reconnect&&u){for(;u;)await H(10);r&&r.readyState===p.OPEN&&(r.send(JSON.stringify({...a,collection:t,type:"subscribe"})),yield*l())}}return{subscription:l(),unsubscribe(){g({uid:a.uid,type:"unsubscribe"}),n=!1}}}}}}var H=e=>new Promise(i=>setTimeout(()=>i(),e));class K{get(){return JSON.parse(localStorage.getItem("directus-data"))}set(i){localStorage.setItem("directus-data",JSON.stringify(i))}}const S=D("https://db.chromatone.center/").with(I({credentials:"include"})).with(R("json",{credentials:"include",storage:new K})).with(G({credentials:"include"})),N=m(),E=m(""),U=m(""),O=m({}),k=m(""),_=m(!1);let J=!1;function Y(){return J||(W(async()=>{await j(),await M()}),J=!0),{access_token:k,email:E,password:U,authData:O,user:N,userDB:S,userCreate:z,userRead:M,refreshToken:j,submitLogin:$,logoutUser:F,claimInvite:X}}async function X(){var e,i,r;if(E.value&&!_.value){const h={email:E.value};try{const o=await fetch("https://db.chromatone.center/flows/trigger/08819864-6d88-41a3-80ff-02d17ec5f620",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(h)});console.log(await(o==null?void 0:o.json()))}catch(o){console.error(o,(i=(e=o==null?void 0:o.errors)==null?void 0:e[0])==null?void 0:i.message,(r=o==null?void 0:o.response)==null?void 0:r.status)}_.value=!0}}async function j(){try{let e=await S.refresh();k.value=e.access_token,delete e.access_token,O.value=e}catch(e){console.log(e.errors[0])}}async function $(){try{let e=await S.login(E.value,U.value);k.value=e.access_token,delete e.access_token,O.value={...e}}catch(e){console.log(e.errors[0])}}async function M(){try{return N.value=await S.request(A()),N.value}catch(e){console.log(e)}}async function z({email:e}){}async function F(){await S.logout(),k.value="",O.value=""}export{Y as u};
