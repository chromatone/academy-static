var S={fetch:globalThis.fetch,WebSocket:globalThis.WebSocket,URL:globalThis.URL},N=(e,t={})=>{let r=t.globals?{...S,...t.globals}:S;return{globals:r,url:new r.URL(e),with(a){return{...this,...a(this)}}}};function O(e){return typeof e!="object"||!e?!1:"headers"in e&&"ok"in e&&"json"in e&&typeof e.json=="function"&&"text"in e&&typeof e.json=="function"}async function R(e){var t;if(!(typeof e!="object"||!e)){if(O(e)){let r=(t=e.headers.get("Content-Type"))==null?void 0:t.toLowerCase();if(r!=null&&r.startsWith("application/json")||r!=null&&r.startsWith("application/health+json")){let a=await e.json();if(!e.ok)throw a;return"data"in a?a.data:a}if(r!=null&&r.startsWith("text/html")||r!=null&&r.startsWith("text/plain")){let a=await e.text();if(!e.ok)throw a;return a}return e}return"data"in e?e.data:e}}var u=async(e,t,r=globalThis.fetch)=>{t.headers=typeof t.headers=="object"&&!Array.isArray(t.headers)?t.headers:{};let a=await r(e,t);return R(a).catch(s=>{throw{errors:typeof s=="object"&&"errors"in s?s.errors:s,response:a}})},x=e=>{let t={};if(Array.isArray(e.fields)&&e.fields.length>0){let r=(a,s=[])=>{if(typeof a=="object"){let l=[];for(let n in a){let i=a[n]??[];if(Array.isArray(i))for(let f of i)l.push(r(f,[...s,n]));else if(typeof i=="object")for(let f of Object.keys(i)){let b=i[f];for(let g of b)l.push(r(g,[...s,`${n}:${f}`]))}}return l.flatMap(n=>n)}return[...s,String(a)].join(".")};t.fields=e.fields.flatMap(a=>r(a)).join(",")}e.filter&&Object.keys(e.filter).length>0&&(t.filter=JSON.stringify(e.filter)),e.search&&(t.search=e.search),"sort"in e&&e.sort&&(t.sort=typeof e.sort=="string"?e.sort:e.sort.join(",")),typeof e.limit=="number"&&e.limit>=-1&&(t.limit=String(e.limit)),typeof e.offset=="number"&&e.offset>=0&&(t.offset=String(e.offset)),typeof e.page=="number"&&e.page>=1&&(t.page=String(e.page)),e.deep&&Object.keys(e.deep).length>0&&(t.deep=JSON.stringify(e.deep)),e.alias&&Object.keys(e.alias).length>0&&(t.alias=JSON.stringify(e.alias)),e.aggregate&&Object.keys(e.aggregate).length>0&&(t.aggregate=JSON.stringify(e.aggregate)),e.groupBy&&e.groupBy.length>0&&(t.groupBy=e.groupBy.join(","));for(let[r,a]of Object.entries(e))r in t||(typeof a=="string"||typeof a=="number"||typeof a=="boolean"?t[r]=String(a):t[r]=JSON.stringify(a));return t},k=(e,t)=>{if(e.length===0)throw new Error(t)},_=(e,t)=>{if(String(e).startsWith("directus_"))throw new Error(t)},B=(e,t,r)=>()=>(k(String(e),"Collection cannot be empty"),_(e,"Cannot use readItem for core collections"),k(String(t),"Key cannot be empty"),{path:`/items/${e}/${t}`,params:r??{},method:"GET"}),W=e=>()=>({path:"/users/me",params:e??{},method:"GET"}),E={},J=(e={})=>t=>{let r={...E,...e};return{async request(a){let s=a();if(s.headers||(s.headers={}),"Content-Type"in s.headers?s.headers["Content-Type"]==="multipart/form-data"&&delete s.headers["Content-Type"]:s.headers["Content-Type"]="application/json","getToken"in this){let f=await this.getToken();f&&(s.headers||(s.headers={}),s.headers.Authorization=`Bearer ${f}`)}let l=d(t.url,s.path,s.params),n={method:s.method??"GET",headers:s.headers??{}};"credentials"in r&&(n.credentials=r.credentials),s.body&&(n.body=s.body),s.onRequest&&(n=await s.onRequest(n)),r.onRequest&&(n=await r.onRequest(n));let i=await u(l.toString(),n,t.globals.fetch);return"onResponse"in s&&(i=await s.onResponse(i,n)),"onResponse"in e&&(i=await e.onResponse(i,n)),i}}},y="/",A=(e,t)=>(e.endsWith(y)&&(e=e.slice(0,-1)),t.startsWith(y)||(t=y+t),e+t),d=(e,t,r)=>{let a=e.pathname===y?t:A(e.pathname,t),s=new globalThis.URL(a,e);if(r)for(let[l,n]of Object.entries(x(r)))if(n&&typeof n=="object"&&!Array.isArray(n))for(let[i,f]of Object.entries(n))s.searchParams.set(`${l}[${i}]`,String(f));else s.searchParams.set(l,n);return s},C=()=>{let e=null;return{get:async()=>e,set:async t=>{e=t}}},v={msRefreshBeforeExpires:3e4,autoRefresh:!0},$=(e="cookie",t={})=>r=>{let a={...v,...t},s=null,l=null,n=a.storage??C(),i=()=>{n.set({access_token:null,refresh_token:null,expires:null,expires_at:null})},f=async()=>{try{await s}finally{s=null}},b=async()=>{let o=await n.get();if(s||!(o!=null&&o.expires_at)){await f();return}o.expires_at<new Date().getTime()+a.msRefreshBeforeExpires&&m().catch(h=>{}),await f()},g=o=>{let h=o.expires??0;o.expires_at=new Date().getTime()+h,n.set(o),a.autoRefresh&&h>a.msRefreshBeforeExpires&&h<Number.MAX_SAFE_INTEGER&&(l&&clearTimeout(l),l=setTimeout(()=>{l=null,m().catch(c=>{})},h-a.msRefreshBeforeExpires))},m=async()=>(s=(async()=>{let o=await n.get();i();let h={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in a&&(h.credentials=a.credentials);let c={mode:e};e==="json"&&(o!=null&&o.refresh_token)&&(c.refresh_token=o.refresh_token),h.body=JSON.stringify(c);let w=d(r.url,"/auth/refresh"),p=await u(w.toString(),h,r.globals.fetch);return g(p),p})().catch(o=>{throw o}),s);return{refresh:m,async login(o,h,c={}){i();let w=d(r.url,"/auth/login"),p={email:o,password:h};"otp"in c&&(p.otp=c.otp),p.mode=c.mode??e;let j={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)};"credentials"in a&&(j.credentials=a.credentials);let T=await u(w.toString(),j,r.globals.fetch);return g(T),T},async logout(){let o=await n.get(),h={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in a&&(h.credentials=a.credentials),e==="json"&&(o!=null&&o.refresh_token)&&(h.body=JSON.stringify({refresh_token:o.refresh_token}));let c=d(r.url,"/auth/logout");await u(c.toString(),h,r.globals.fetch),l&&clearTimeout(l),i()},async getToken(){var o;return await b(),((o=await n.get())==null?void 0:o.access_token)??null},setToken(o){n.set({access_token:o,refresh_token:null,expires:null,expires_at:null})}}};export{$ as a,J as j,B as l,W as u,N as w};
