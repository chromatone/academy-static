import{E as T,G as D}from"./framework.OAs4rAHB.js";var L={fetch:globalThis.fetch,WebSocket:globalThis.WebSocket,URL:globalThis.URL},$=(e,r={})=>{let t=r.globals?{...L,...r.globals}:L;return{globals:t,url:new t.URL(e),with(s){return{...this,...s(this)}}}};function q(e){return typeof e!="object"||!e?!1:"headers"in e&&"ok"in e&&"json"in e&&typeof e.json=="function"&&"text"in e&&typeof e.json=="function"}async function I(e){var r;if(!(typeof e!="object"||!e)){if(q(e)){let t=(r=e.headers.get("Content-Type"))==null?void 0:r.toLowerCase();if(t!=null&&t.startsWith("application/json")||t!=null&&t.startsWith("application/health+json")){let s=await e.json();if(!e.ok)throw s;return"data"in s?s.data:s}if(t!=null&&t.startsWith("text/html")||t!=null&&t.startsWith("text/plain")){let s=await e.text();if(!e.ok)throw s;return s}return e}return"data"in e?e.data:e}}var O=async(e,r,t=globalThis.fetch)=>{r.headers=typeof r.headers=="object"&&!Array.isArray(r.headers)?r.headers:{};let s=await t(e,r);return I(s).catch(a=>{throw{errors:typeof a=="object"&&"errors"in a?a.errors:a,response:s}})},G=e=>{let r={};if(Array.isArray(e.fields)&&e.fields.length>0){let t=(s,a=[])=>{if(typeof s=="object"){let c=[];for(let o in s){let h=s[o]??[];if(Array.isArray(h))for(let y of h)c.push(t(y,[...a,o]));else if(typeof h=="object")for(let y of Object.keys(h)){let w=h[y];for(let S of w)c.push(t(S,[...a,`${o}:${y}`]))}}return c.flatMap(o=>o)}return[...a,String(s)].join(".")};r.fields=e.fields.flatMap(s=>t(s)).join(",")}e.filter&&Object.keys(e.filter).length>0&&(r.filter=JSON.stringify(e.filter)),e.search&&(r.search=e.search),"sort"in e&&e.sort&&(r.sort=typeof e.sort=="string"?e.sort:e.sort.join(",")),typeof e.limit=="number"&&e.limit>=-1&&(r.limit=String(e.limit)),typeof e.offset=="number"&&e.offset>=0&&(r.offset=String(e.offset)),typeof e.page=="number"&&e.page>=1&&(r.page=String(e.page)),e.deep&&Object.keys(e.deep).length>0&&(r.deep=JSON.stringify(e.deep)),e.alias&&Object.keys(e.alias).length>0&&(r.alias=JSON.stringify(e.alias)),e.aggregate&&Object.keys(e.aggregate).length>0&&(r.aggregate=JSON.stringify(e.aggregate)),e.groupBy&&e.groupBy.length>0&&(r.groupBy=e.groupBy.join(","));for(let[t,s]of Object.entries(e))t in r||(typeof s=="string"||typeof s=="number"||typeof s=="boolean"?r[t]=String(s):r[t]=JSON.stringify(s));return r},F=e=>()=>({path:"/users/me",params:e??{},method:"GET"}),Q={},X=(e={})=>r=>{let t={...Q,...e};return{async request(s){let a=s();if(a.headers||(a.headers={}),"Content-Type"in a.headers?a.headers["Content-Type"]==="multipart/form-data"&&delete a.headers["Content-Type"]:a.headers["Content-Type"]="application/json","getToken"in this){let y=await this.getToken();y&&(a.headers||(a.headers={}),a.headers.Authorization=`Bearer ${y}`)}let c=E(r.url,a.path,a.params),o={method:a.method??"GET",headers:a.headers??{}};"credentials"in t&&(o.credentials=t.credentials),a.body&&(o.body=a.body),a.onRequest&&(o=await a.onRequest(o)),t.onRequest&&(o=await t.onRequest(o));let h=await O(c.toString(),o,r.globals.fetch);return"onResponse"in a&&(h=await a.onResponse(h,o)),"onResponse"in e&&(h=await e.onResponse(h,o)),h}}},j="/",z=(e,r)=>(e.endsWith(j)&&(e=e.slice(0,-1)),r.startsWith(j)||(r=j+r),e+r),E=(e,r,t)=>{let s=e.pathname===j?r:z(e.pathname,r),a=new globalThis.URL(s,e);if(t)for(let[c,o]of Object.entries(G(t)))if(o&&typeof o=="object"&&!Array.isArray(o))for(let[h,y]of Object.entries(o))a.searchParams.set(`${c}[${h}]`,String(y));else a.searchParams.set(c,o);return a},H=()=>{let e=null;return{get:async()=>e,set:async r=>{e=r}}},K={msRefreshBeforeExpires:3e4,autoRefresh:!0},V=(e="cookie",r={})=>t=>{let s={...K,...r},a=null,c=null,o=s.storage??H(),h=()=>{o.set({access_token:null,refresh_token:null,expires:null,expires_at:null})},y=async()=>{try{await a}finally{a=null}},w=async()=>{let l=await o.get();if(a||!(l!=null&&l.expires_at)){await y();return}l.expires_at<new Date().getTime()+s.msRefreshBeforeExpires&&p().catch(n=>{}),await y()},S=l=>{let n=l.expires??0;l.expires_at=new Date().getTime()+n,o.set(l),s.autoRefresh&&n>s.msRefreshBeforeExpires&&n<Number.MAX_SAFE_INTEGER&&(c&&clearTimeout(c),c=setTimeout(()=>{c=null,p().catch(i=>{})},n-s.msRefreshBeforeExpires))},p=async()=>(a=(async()=>{let l=await o.get();h();let n={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in s&&(n.credentials=s.credentials);let i={mode:e};e==="json"&&(l!=null&&l.refresh_token)&&(i.refresh_token=l.refresh_token),n.body=JSON.stringify(i);let u=E(t.url,"/auth/refresh"),f=await O(u.toString(),n,t.globals.fetch);return S(f),f})().catch(l=>{throw l}),a);return{refresh:p,async login(l,n,i={}){h();let u=E(t.url,"/auth/login"),f={email:l,password:n};"otp"in i&&(f.otp=i.otp),f.mode=i.mode??e;let b={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)};"credentials"in s&&(b.credentials=s.credentials);let g=await O(u.toString(),b,t.globals.fetch);return S(g),g},async logout(){let l=await o.get(),n={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in s&&(n.credentials=s.credentials),e==="json"&&(l!=null&&l.refresh_token)&&(n.body=JSON.stringify({refresh_token:l.refresh_token}));let i=E(t.url,"/auth/logout");await O(i.toString(),n,t.globals.fetch),c&&clearTimeout(c),h()},async getToken(){var l;return await w(),((l=await o.get())==null?void 0:l.access_token)??null},setToken(l){o.set({access_token:l,refresh_token:null,expires:null,expires_at:null})}}};function P(e){return JSON.stringify({...e,type:"auth"})}var Y=()=>JSON.stringify({type:"pong"}),J=(e,r=1e3)=>new Promise((t,s)=>{let a=y=>{try{let w=JSON.parse(y.data);typeof w=="object"&&!Array.isArray(w)&&w!==null?(o(),t(w)):(o(),c())}catch{o(),t(y)}},c=()=>s(),o=()=>{clearTimeout(h),e.removeEventListener("message",a),e.removeEventListener("error",c),e.removeEventListener("close",c)};e.addEventListener("message",a),e.addEventListener("error",c),e.addEventListener("close",c);let h=setTimeout(()=>{o(),t(void 0)},r)});function*A(){let e=1;for(;;)yield String(e),e++}var Z={authMode:"handshake",heartbeat:!0,reconnect:{delay:1e3,retries:10}},k={OPEN:1,CLOSED:3};function ee(e={}){return r=>{e={...Z,...e};let t=null,s=A(),a=0,c=!1,o=n=>"getToken"in n,h=async(n,i)=>{if(e.authMode==="strict"&&o(i)){let u=await i.getToken();u&&n.searchParams.set("access_token",u)}return n},y=async n=>{if("url"in e)return await h(new r.globals.URL(e.url),n);if(["ws:","wss:"].includes(r.url.protocol))return await h(r.url,n);let i=new r.globals.URL(r.url.toString());return i.protocol=r.url.protocol==="https:"?"wss:":"ws:",i.pathname="/websocket",await h(i,n)},w=()=>{t=null,s=A()};function S(){e.reconnect&&!c&&a<e.reconnect.retries?(c=!0,setTimeout(()=>{a+=1,this.connect().then(()=>{a=0,c=!1}).catch(()=>{})},Math.max(1,e.reconnect.delay))):c=!1}let p={open:new Set([]),error:new Set([]),close:new Set([]),message:new Set([])},l=async(n,i)=>{for(;n.readyState!==k.CLOSED;){let u=await J(n).catch(()=>{});if(u){if("type"in u){if(u.type==="auth"&&"status"in u&&u.status==="error"&&"error"in u){if(u.error==="TOKEN_EXPIRED"&&o(i)){let f=await i.getToken();if(f){n.send(P({access_token:f}));continue}}if(u.error==="AUTH_TIMEOUT"){n.close();continue}}if(e.heartbeat&&u.type==="ping"){n.send(Y());continue}}p.message.forEach(f=>f.call(n,u))}}};return{async connect(){let n=this,i=await y(n);return new Promise((u,f)=>{let b=!1,g=new r.globals.WebSocket(i);g.addEventListener("open",async d=>{if(e.authMode==="handshake"&&o(n)){let m=await n.getToken();m&&g.send(P({access_token:m}))}b=!0,p.open.forEach(m=>m.call(g,d)),l(g,n),u()}),g.addEventListener("error",d=>{p.error.forEach(m=>m.call(g,d)),g.close(),b||f(d)}),g.addEventListener("close",d=>{p.close.forEach(m=>m.call(g,d)),w(),S.call(this),b||f(d)}),t=g})},disconnect(){t&&(t==null?void 0:t.readyState)===k.OPEN&&t.close(),t=null},onWebSocket(n,i){if(n==="message"){let u=function(f){if(typeof f.data!="string")return i.call(this,f);try{return i.call(this,JSON.parse(f.data))}catch{return i.call(this,f)}};return p[n].add(u),()=>p[n].delete(u)}return p[n].add(i),()=>p[n].delete(i)},sendMessage(n){if(!t||(t==null?void 0:t.readyState)!==k.OPEN)throw new Error("websocket connection not OPEN");if(typeof n=="string"){t.send(n);return}"uid"in n||(n.uid=s.next().value),t==null||t.send(JSON.stringify(n))},async subscribe(n,i={}){(!t||t.readyState!==k.OPEN)&&await this.connect(),"uid"in i||(i.uid=s.next().value);let u=!0,f=t,b=d=>f.send(JSON.stringify(d));b({...i,collection:n,type:"subscribe"});async function*g(){for(;u&&f&&f.readyState===k.OPEN;){let d=await J(f).catch(()=>{});if(d){if("type"in d&&"status"in d&&d.type==="subscribe"&&d.status==="error")throw d;"type"in d&&"uid"in d&&d.type==="subscription"&&d.uid===i.uid&&(yield d)}}if(e.reconnect&&c){for(;c;)await te(10);t&&t.readyState===k.OPEN&&(t.send(JSON.stringify({...i,collection:n,type:"subscribe"})),yield*g())}}return{subscription:g(),unsubscribe(){b({uid:i.uid,type:"unsubscribe"}),u=!1}}}}}}var te=e=>new Promise(r=>setTimeout(()=>r(),e));class re{get(){return JSON.parse(localStorage.getItem("directus-data"))}set(r){localStorage.setItem("directus-data",JSON.stringify(r))}}const v=$("https://db.chromatone.center/").with(X({credentials:"include"})).with(V("json",{credentials:"include",storage:new re})).with(ee({credentials:"include"})),x=T(),_=T(""),U=T(""),N=T({}),R=T(""),C=T(!1);let W=!1;function le(){return W||(D(async()=>{await B(),await M()}),W=!0),{access_token:R,email:_,password:U,authData:N,user:x,userDB:v,userCreate:se,userRead:M,refreshToken:B,submitLogin:ne,logoutUser:oe,claimInvite:ae}}async function ae(){var e,r,t;if(_.value&&!C.value){const s={email:_.value};try{const a=await fetch("https://db.chromatone.center/flows/trigger/08819864-6d88-41a3-80ff-02d17ec5f620",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(s)});console.log(await(a==null?void 0:a.json()))}catch(a){console.error(a,(r=(e=a==null?void 0:a.errors)==null?void 0:e[0])==null?void 0:r.message,(t=a==null?void 0:a.response)==null?void 0:t.status)}C.value=!0}}async function B(){try{let e=await v.refresh();R.value=e.access_token,delete e.access_token,N.value=e}catch(e){console.log(e.errors[0])}}async function ne(){try{let e=await v.login(_.value,U.value);R.value=e.access_token,delete e.access_token,N.value={...e}}catch(e){console.log(e.errors[0])}}async function M(){try{return x.value=await v.request(F()),x.value}catch(e){console.log(e)}}async function se({email:e}){}async function oe(){await v.logout(),R.value="",N.value=""}export{le as u};
