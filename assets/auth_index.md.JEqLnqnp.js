import{r as S,d as H,o as T,c as O,b as g,t as B,u as b,e as K,w as $,v as J,i as A,f as Y,g as Q,F as Z,_ as ee}from"./chunks/framework.PSFX71cf.js";var D={fetch:globalThis.fetch,WebSocket:globalThis.WebSocket,URL:globalThis.URL},te=(e,s={})=>{let t=s.globals?{...D,...s.globals}:D;return{globals:t,url:new t.URL(e),with(n){return{...this,...n(this)}}}};function re(e){return typeof e!="object"||!e?!1:"headers"in e&&"ok"in e&&"json"in e&&typeof e.json=="function"&&"text"in e&&typeof e.json=="function"}async function ae(e){var s;if(!(typeof e!="object"||!e)){if(re(e)){let t=(s=e.headers.get("Content-Type"))==null?void 0:s.toLowerCase();if(t!=null&&t.startsWith("application/json")||t!=null&&t.startsWith("application/health+json")){let n=await e.json();if(!e.ok)throw n;return"data"in n?n.data:n}if(t!=null&&t.startsWith("text/html")||t!=null&&t.startsWith("text/plain")){let n=await e.text();if(!e.ok)throw n;return n}return e}return"data"in e?e.data:e}}var j=async(e,s,t=globalThis.fetch)=>{s.headers=typeof s.headers=="object"&&!Array.isArray(s.headers)?s.headers:{};let n=await t(e,s);return ae(n).catch(a=>{throw{errors:typeof a=="object"&&"errors"in a?a.errors:a,response:n}})},se=e=>{let s={};if(Array.isArray(e.fields)&&e.fields.length>0){let t=(n,a=[])=>{if(typeof n=="object"){let c=[];for(let o in n){let u=n[o]??[];if(Array.isArray(u))for(let h of u)c.push(t(h,[...a,o]));else if(typeof u=="object")for(let h of Object.keys(u)){let w=u[h];for(let _ of w)c.push(t(_,[...a,`${o}:${h}`]))}}return c.flatMap(o=>o)}return[...a,String(n)].join(".")};s.fields=e.fields.flatMap(n=>t(n)).join(",")}e.filter&&Object.keys(e.filter).length>0&&(s.filter=JSON.stringify(e.filter)),e.search&&(s.search=e.search),"sort"in e&&e.sort&&(s.sort=typeof e.sort=="string"?e.sort:e.sort.join(",")),typeof e.limit=="number"&&e.limit>=-1&&(s.limit=String(e.limit)),typeof e.offset=="number"&&e.offset>=0&&(s.offset=String(e.offset)),typeof e.page=="number"&&e.page>=1&&(s.page=String(e.page)),e.deep&&Object.keys(e.deep).length>0&&(s.deep=JSON.stringify(e.deep)),e.alias&&Object.keys(e.alias).length>0&&(s.alias=JSON.stringify(e.alias)),e.aggregate&&Object.keys(e.aggregate).length>0&&(s.aggregate=JSON.stringify(e.aggregate)),e.groupBy&&e.groupBy.length>0&&(s.groupBy=e.groupBy.join(","));for(let[t,n]of Object.entries(e))t in s||(typeof n=="string"||typeof n=="number"||typeof n=="boolean"?s[t]=String(n):s[t]=JSON.stringify(n));return s},ne=e=>()=>({path:"/users/me",params:e??{},method:"GET"}),oe={},ie=(e={})=>s=>{let t={...oe,...e};return{async request(n){let a=n();if(a.headers||(a.headers={}),"Content-Type"in a.headers?a.headers["Content-Type"]==="multipart/form-data"&&delete a.headers["Content-Type"]:a.headers["Content-Type"]="application/json","getToken"in this){let h=await this.getToken();h&&(a.headers||(a.headers={}),a.headers.Authorization=`Bearer ${h}`)}let c=R(s.url,a.path,a.params),o={method:a.method??"GET",headers:a.headers??{}};"credentials"in t&&(o.credentials=t.credentials),a.body&&(o.body=a.body),a.onRequest&&(o=await a.onRequest(o)),t.onRequest&&(o=await t.onRequest(o));let u=await j(c.toString(),o,s.globals.fetch);return"onResponse"in a&&(u=await a.onResponse(u,o)),"onResponse"in e&&(u=await e.onResponse(u,o)),u}}},N="/",le=(e,s)=>(e.endsWith(N)&&(e=e.slice(0,-1)),s.startsWith(N)||(s=N+s),e+s),R=(e,s,t)=>{let n=e.pathname===N?s:le(e.pathname,s),a=new globalThis.URL(n,e);if(t)for(let[c,o]of Object.entries(se(t)))if(o&&typeof o=="object"&&!Array.isArray(o))for(let[u,h]of Object.entries(o))a.searchParams.set(`${c}[${u}]`,String(h));else a.searchParams.set(c,o);return a},ce=()=>{let e=null;return{get:async()=>e,set:async s=>{e=s}}},de={msRefreshBeforeExpires:3e4,autoRefresh:!0},ue=(e="cookie",s={})=>t=>{let n={...de,...s},a=null,c=null,o=n.storage??ce(),u=()=>{o.set({access_token:null,refresh_token:null,expires:null,expires_at:null})},h=async()=>{try{await a}finally{a=null}},w=async()=>{let d=await o.get();if(a||!(d!=null&&d.expires_at)){await h();return}d.expires_at<new Date().getTime()+n.msRefreshBeforeExpires&&m().catch(r=>{}),await h()},_=d=>{let r=d.expires??0;d.expires_at=new Date().getTime()+r,o.set(d),n.autoRefresh&&r>n.msRefreshBeforeExpires&&r<Number.MAX_SAFE_INTEGER&&(c&&clearTimeout(c),c=setTimeout(()=>{c=null,m().catch(l=>{})},r-n.msRefreshBeforeExpires))},m=async()=>(a=(async()=>{let d=await o.get();u();let r={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in n&&(r.credentials=n.credentials);let l={mode:e};e==="json"&&(d!=null&&d.refresh_token)&&(l.refresh_token=d.refresh_token),r.body=JSON.stringify(l);let i=R(t.url,"/auth/refresh"),f=await j(i.toString(),r,t.globals.fetch);return _(f),f})().catch(d=>{throw d}),a);return{refresh:m,async login(d,r,l={}){u();let i=R(t.url,"/auth/login"),f={email:d,password:r};"otp"in l&&(f.otp=l.otp),f.mode=l.mode??e;let k={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)};"credentials"in n&&(k.credentials=n.credentials);let y=await j(i.toString(),k,t.globals.fetch);return _(y),y},async logout(){let d=await o.get(),r={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in n&&(r.credentials=n.credentials),e==="json"&&(d!=null&&d.refresh_token)&&(r.body=JSON.stringify({refresh_token:d.refresh_token}));let l=R(t.url,"/auth/logout");await j(l.toString(),r,t.globals.fetch),c&&clearTimeout(c),u()},async getToken(){var d;return await w(),((d=await o.get())==null?void 0:d.access_token)??null},setToken(d){o.set({access_token:d,refresh_token:null,expires:null,expires_at:null})}}};function M(e){return JSON.stringify({...e,type:"auth"})}var fe=()=>JSON.stringify({type:"pong"}),W=(e,s=1e3)=>new Promise((t,n)=>{let a=h=>{try{let w=JSON.parse(h.data);typeof w=="object"&&!Array.isArray(w)&&w!==null?(o(),t(w)):(o(),c())}catch{o(),t(h)}},c=()=>n(),o=()=>{clearTimeout(u),e.removeEventListener("message",a),e.removeEventListener("error",c),e.removeEventListener("close",c)};e.addEventListener("message",a),e.addEventListener("error",c),e.addEventListener("close",c);let u=setTimeout(()=>{o(),t(void 0)},s)});function*I(){let e=1;for(;;)yield String(e),e++}var he={authMode:"handshake",heartbeat:!0,reconnect:{delay:1e3,retries:10}},x={OPEN:1,CLOSED:3};function pe(e={}){return s=>{e={...he,...e};let t=null,n=I(),a=0,c=!1,o=r=>"getToken"in r,u=async(r,l)=>{if(e.authMode==="strict"&&o(l)){let i=await l.getToken();i&&r.searchParams.set("access_token",i)}return r},h=async r=>{if("url"in e)return await u(new s.globals.URL(e.url),r);if(["ws:","wss:"].includes(s.url.protocol))return await u(s.url,r);let l=new s.globals.URL(s.url.toString());return l.protocol=s.url.protocol==="https:"?"wss:":"ws:",l.pathname="/websocket",await u(l,r)},w=()=>{t=null,n=I()};function _(){e.reconnect&&!c&&a<e.reconnect.retries?(c=!0,setTimeout(()=>{a+=1,this.connect().then(()=>{a=0,c=!1}).catch(()=>{})},Math.max(1,e.reconnect.delay))):c=!1}let m={open:new Set([]),error:new Set([]),close:new Set([]),message:new Set([])},d=async(r,l)=>{for(;r.readyState!==x.CLOSED;){let i=await W(r).catch(()=>{});if(i){if("type"in i){if(i.type==="auth"&&"status"in i&&i.status==="error"&&"error"in i){if(i.error==="TOKEN_EXPIRED"&&o(l)){let f=await l.getToken();if(f){r.send(M({access_token:f}));continue}}if(i.error==="AUTH_TIMEOUT"){r.close();continue}}if(e.heartbeat&&i.type==="ping"){r.send(fe());continue}}m.message.forEach(f=>f.call(r,i))}}};return{async connect(){let r=this,l=await h(r);return new Promise((i,f)=>{let k=!1,y=new s.globals.WebSocket(l);y.addEventListener("open",async p=>{if(e.authMode==="handshake"&&o(r)){let v=await r.getToken();v&&y.send(M({access_token:v}))}k=!0,m.open.forEach(v=>v.call(y,p)),d(y,r),i()}),y.addEventListener("error",p=>{m.error.forEach(v=>v.call(y,p)),y.close(),k||f(p)}),y.addEventListener("close",p=>{m.close.forEach(v=>v.call(y,p)),w(),_.call(this),k||f(p)}),t=y})},disconnect(){t&&(t==null?void 0:t.readyState)===x.OPEN&&t.close(),t=null},onWebSocket(r,l){if(r==="message"){let i=function(f){if(typeof f.data!="string")return l.call(this,f);try{return l.call(this,JSON.parse(f.data))}catch{return l.call(this,f)}};return m[r].add(i),()=>m[r].delete(i)}return m[r].add(l),()=>m[r].delete(l)},sendMessage(r){if(!t||(t==null?void 0:t.readyState)!==x.OPEN)throw new Error("websocket connection not OPEN");if(typeof r=="string"){t.send(r);return}"uid"in r||(r.uid=n.next().value),t==null||t.send(JSON.stringify(r))},async subscribe(r,l={}){(!t||t.readyState!==x.OPEN)&&await this.connect(),"uid"in l||(l.uid=n.next().value);let i=!0,f=t,k=p=>f.send(JSON.stringify(p));k({...l,collection:r,type:"subscribe"});async function*y(){for(;i&&f&&f.readyState===x.OPEN;){let p=await W(f).catch(()=>{});if(p){if("type"in p&&"status"in p&&p.type==="subscribe"&&p.status==="error")throw p;"type"in p&&"uid"in p&&p.type==="subscription"&&p.uid===l.uid&&(yield p)}}if(e.reconnect&&c){for(;c;)await ge(10);t&&t.readyState===x.OPEN&&(t.send(JSON.stringify({...l,collection:r,type:"subscribe"})),yield*y())}}return{subscription:y(),unsubscribe(){k({uid:l.uid,type:"unsubscribe"}),i=!1}}}}}}var ge=e=>new Promise(s=>setTimeout(()=>s(),e));class ye{get(){return JSON.parse(localStorage.getItem("directus-data"))}set(s){localStorage.setItem("directus-data",JSON.stringify(s))}}const E=te("https://db.chromatone.center/").with(ie({credentials:"include"})).with(ue("json",{credentials:"include",storage:new ye})).with(pe({credentials:"include"})),U=S(),L=S(""),X=S(""),P=S({}),C=S(""),q=S(!1);let V=!1;function z(){return V||(H(async()=>{await F(),await G()}),V=!0),{access_token:C,email:L,password:X,authData:P,user:U,userDB:E,userCreate:we,userRead:G,refreshToken:F,submitLogin:me,logoutUser:ke,claimInvite:be}}async function be(){var e,s,t;if(L.value&&!q.value){const n={email:L.value};try{const a=await fetch("https://db.chromatone.center/flows/trigger/08819864-6d88-41a3-80ff-02d17ec5f620",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(n)});console.log(await(a==null?void 0:a.json()))}catch(a){console.error(a,(s=(e=a==null?void 0:a.errors)==null?void 0:e[0])==null?void 0:s.message,(t=a==null?void 0:a.response)==null?void 0:t.status)}q.value=!0}}async function F(){try{let e=await E.refresh();C.value=e.access_token,delete e.access_token,P.value=e}catch(e){console.log(e.errors[0])}}async function me(){try{let e=await E.login(L.value,X.value);C.value=e.access_token,delete e.access_token,P.value={...e}}catch(e){console.log(e.errors[0])}}async function G(){try{return U.value=await E.request(ne()),U.value}catch(e){console.log(e)}}async function we({email:e}){}async function ke(){await E.logout(),C.value="",P.value=""}const _e={class:"flex flex-col gap-4 p-4"},ve=g("div",{class:"text-xl"},"Profile",-1),xe={class:"text-sm"},Se={__name:"AuthProfile",setup(e){const{user:s}=z();return(t,n)=>(T(),O("div",_e,[ve,g("pre",xe,B(b(s)),1)]))}},Te={class:"text-lg",for:"email"},Oe=g("div",{class:"text-2xl"},"Login to your account",-1),Ee=g("label",{class:"text-lg",for:"email"},"E-mail*:",-1),je=g("label",{class:"text-lg",for:"email"},"Password:",-1),Ne={key:1,class:"flex flex-col gap-2"},Re={class:"font-mono text-xs"},Le={class:"text-sm"},Pe={class:"flex"},Ce={__name:"AuthLogin",setup(e){const{userRead:s,user:t,userDB:n,email:a,password:c,authData:o,access_token:u,submitLogin:h,refreshToken:w,logoutUser:_,claimInvite:m}=z();return(d,r)=>{const l=Se;return T(),O(Z,null,[g("label",Te,[K("E-mail*:"),$(g("input",{class:"rounded-lg p-2 border-2 border-solid dark-border-light-300 border-dark-800 shadow-inner dark-bg-dark-200",id:"email",type:"text","onUpdate:modelValue":r[0]||(r[0]=i=>A(a)?a.value=i:null)},null,512),[[J,b(a)]])]),g("button",{class:"text-xl font-bold rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-lg dark-bg-dark-200",type:"submit",onClick:r[1]||(r[1]=i=>b(m)())},"Claim Invite"),b(u)?(T(),O("div",Ne,[g("p",Re,"."+B(b(u).split(".")[2]),1),g("pre",Le,B(b(o)),1),g("div",Pe,[g("button",{class:"text-xl font-bold rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-lg dark-bg-dark-200",type:"submit",onClick:r[6]||(r[6]=i=>b(w)())},"Refresh"),g("button",{class:"text-xl font-bold rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-lg dark-bg-dark-200",type:"submit",onClick:r[7]||(r[7]=i=>b(_)())},"Log out")]),g("button",{class:"text-xl font-bold rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-lg dark-bg-dark-200",type:"submit",onClick:r[8]||(r[8]=i=>b(s)())},"Read user"),Q(l)])):(T(),O("form",{key:0,class:"flex flex-col gap-4",onSubmit:r[5]||(r[5]=Y((...i)=>b(h)&&b(h)(...i),["prevent"]))},[Oe,Ee,$(g("input",{class:"rounded-lg p-2 border-2 border-solid dark-border-light-300 border-dark-800 shadow-inner dark-bg-dark-200",id:"email",type:"text","onUpdate:modelValue":r[2]||(r[2]=i=>A(a)?a.value=i:null)},null,512),[[J,b(a)]]),je,$(g("input",{class:"rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-inner dark-bg-dark-200",type:"password","onUpdate:modelValue":r[3]||(r[3]=i=>A(c)?c.value=i:null)},null,512),[[J,b(c)]]),g("button",{class:"text-xl font-bold rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-lg dark-bg-dark-200",type:"submit",onClick:r[4]||(r[4]=(...i)=>b(h)&&b(h)(...i))},"Sign In")],32))],64)}}},Be=JSON.parse('{"title":"Login","description":"","frontmatter":{"title":"Login","desctiption":"Get in touch with community through contributions"},"headers":[],"relativePath":"auth/index.md","filePath":"auth/index.md"}'),$e={name:"auth/index.md"};function Je(e,s,t,n,a,c){const o=Ce;return T(),O("div",null,[Q(o)])}const Ue=ee($e,[["render",Je]]);export{Be as __pageData,Ue as default};
